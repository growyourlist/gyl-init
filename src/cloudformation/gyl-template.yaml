Parameters:
  KeyName:
    Description: The EC2 Key Pair to allow SSH access to the GylEC2Main instance
    Type: AWS::EC2::KeyPair::KeyName
  GylVersion:
    Description: GYL Version
    Type: String
  LambdaBucketName:
    Description: Lambda Bucket
    Type: String
  ApiAuthKeyHash:
    Description: Key for authorizing API requests
    Type: String
  DbTablePrefix:
    Description: Prefix for DynamoDB tables
    Type: String
  SesSourceEmail:
    Description: Source email used by SES
    Type: String
  AdminEmail:
    Description: Email to receive errors and other GYL operating information
    Type: String
  QueueUserAccessKeyId:
    Description: The id of the access key used by GYL Queue system
    Type: String
  QueueUserSecretAccessKey:
    Description: The secret access key used by GYL Queue system
    Type: String
  BroadcastUserAccessKeyId:
    Description: The id of the access key used by GYL Broadcast system
    Type: String
  BroadcastUserSecretAccessKey:
    Description: The secret access key used by GYL Broadcast system
    Type: String

Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-062f7200baf2fa504
    us-east-2:
      AMI: ami-02ccb28830b645a41
    us-west-1:
      AMI: ami-03caa3f860895f82e
    us-west-2:
      AMI: ami-04590e7389a6e577c
    sa-east-1:
      AMI: ami-09de7b4017733e2af
    eu-north-1:
      AMI: ami-0662eb9b9b8685935
    eu-west-3:
      AMI: ami-007fae589fdf6e955
    eu-west-2:
      AMI: ami-0089b31e09ac3fffc
    eu-west-1:
      AMI: ami-0713f98de93617bb4
    eu-central-1:
      AMI: ami-07cda0db070313c52
    ca-central-1:
      AMI: ami-0a269ca7cc3e3beff
    ap-northeast-1:
      AMI: ami-011facbea5ec0363b
    ap-southeast-2:
      AMI: ami-0b8b10b5bf11f3a22
    ap-southeast-1:
      AMI: ami-05c64f7b4062b0a21

Resources:
  # EC2
  GylEC2Main:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: 't2.micro'
      KeyName: !Ref KeyName
      SecurityGroups:
        - !Ref GylEC2MainSecurityGroup
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - AMI
      BlockDeviceMappings:
        - DeviceName: '/dev/xvda'
          Ebs:
            VolumeType: 'gp2'
            VolumeSize: '8'
            DeleteOnTermination: 'true'
      UserData: !Base64 
        'Fn::Join':
          - ''
          - - |
              #!/bin/bash -xe
            - |
              # Install the files and packages from the metadata
            - '/opt/aws/bin/cfn-init -v'
            - ' --stack '
            - !Ref 'AWS::StackName'
            - ' --resource GylEC2Main'
            - ' --region '
            - !Ref 'AWS::Region'
            - ' --configsets installGylDependencies'
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          installGylDependencies:
            - installGylDependencies
        installGylDependencies:
          files:
            '/tmp/gyl-queue.env':
              encoding: plain
              mode: '000644'
              owner: root
              group: root
              content: !Sub
                - |
                  SOURCE_EMAIL=${SourceEmail}
                  FALLBACK_SOURCE_EMAIL=${FallbackSourceEmail}
                  UNSUBSCRIBE_LINK_TEMPLATE=${UnsubscribeLinkTemplate}
                  DB_TABLE_PREFIX="${DbPrefix}"
                  AWS_REGION="${AwsRegion}"
                  AWS_ACCESS_KEY_ID=${AwsAccessKeyId}
                  AWS_SECRET_ACCESS_KEY=${AwsSecretAccessKey}

                -
                  SourceEmail: !Ref SesSourceEmail
                  FallbackSourceEmail: !Ref SesSourceEmail
                  UnsubscribeLinkTemplate: 'test'
                  DbPrefix: !Ref DbTablePrefix
                  AwsRegion: !Ref AWS::Region
                  AwsAccessKeyId: !Ref QueueUserAccessKeyId
                  AwsSecretAccessKey: !Ref QueueUserSecretAccessKey

            '/tmp/gyl-broadcaster.env':
              encoding: plain
              mode: '000644'
              owner: root
              group: root
              content: !Sub
                - |
                  DB_TABLE_PREFIX="${DbPrefix}"
                  AWS_REGION="${AwsRegion}"
                  AWS_ACCESS_KEY_ID=${AwsAccessKeyId}
                  AWS_SECRET_ACCESS_KEY=${AwsSecretAccessKey}

                - 
                  DbPrefix: !Ref DbTablePrefix
                  AwsRegion: !Ref AWS::Region
                  AwsAccessKeyId: !Ref BroadcastUserAccessKeyId
                  AwsSecretAccessKey: !Ref BroadcastUserSecretAccessKey

            '/etc/systemd/system/gyl-queue.service':
              encoding: plain
              mode: '000644'
              owner: root
              group: root
              content: |
                [Unit]
                Description=Grow Your List Queue Service

                [Service]
                ExecStart=/usr/bin/node src/gyl-queue.js
                WorkingDirectory=/var/growyourlist/gyl-queue
                Restart=always
                SyslogIdentifier=GYL-Queue
                User=ec2-user
                Group=ec2-user
                Environment=PATH=/usr/bin:/usr/local/bin
                Environment=NODE_ENV=production

                [Install]
                WantedBy=multi-user.target

            '/etc/systemd/system/gyl-broadcaster.service':
              encoding: plain
              mode: '000644'
              owner: root
              group: root
              content: |
                [Unit]
                Description=Grow Your List Broadcaster Service

                [Service]
                ExecStart=/usr/bin/node src/gyl-check-for-broadcaster-trigger.js
                WorkingDirectory=/var/growyourlist/gyl-broadcaster
                Restart=always
                SyslogIdentifier=GYL-Broadcaster
                User=ec2-user
                Group=ec2-user
                Environment=PATH=/usr/bin:/usr/local/bin
                Environment=NODE_ENV=production

                [Install]
                WantedBy=multi-user.target

            '/etc/systemd/system/gyl-subscriber-count.service':
              encoding: plain
              mode: '000644'
              owner: root
              group: root
              content: |
                [Unit]
                Description=Grow Your List Subscriber Count Service

                [Service]
                ExecStart=/usr/bin/node src/gyl-check-for-subscriber-count-trigger.js
                WorkingDirectory=/var/growyourlist/gyl-broadcaster
                Restart=always
                SyslogIdentifier=GYL-Subscriber-Count
                User=ec2-user
                Group=ec2-user
                Environment=PATH=/usr/bin:/usr/local/bin
                Environment=NODE_ENV=production

                [Install]
                WantedBy=multi-user.target

            '/tmp/gyl-install-dependencies.sh':
              encoding: plain
              mode: '000644'
              owner: root
              group: root
              content: |
                #!/bin/bash
                # Update packages
                sudo yum update -y

                # Install Node
                curl -sL https://rpm.nodesource.com/setup_12.x | sudo bash -
                sudo yum install -y nodejs
                sudo yum install -y gcc-c++ make

                # Install Yarn
                curl -sL https://dl.yarnpkg.com/rpm/yarn.repo | sudo tee /etc/yum.repos.d/yarn.repo
                sudo yum install -y yarn

                # Install Git
                sudo yum install -y git

                # Install GYL Queue
                mkdir /var/growyourlist
                git clone https://github.com/growyourlist/gyl-queue /var/growyourlist/gyl-queue
                cd /var/growyourlist/gyl-queue
                yarn install -y

                # Install GYL Broadcaster
                git clone https://github.com/growyourlist/gyl-broadcaster /var/growyourlist/gyl-broadcaster
                cd /var/growyourlist/gyl-broadcaster
                yarn install -y

            '/tmp/gyl-mv-env-files.sh':
              encoding: plain
              mode: '000644'
              owner: root
              group: root
              content: |
                #!/bin/bash
                touch /tmp/attempted-mv
                mv /tmp/gyl-queue.env /var/growyourlist/gyl-queue/.env
                mv /tmp/gyl-broadcaster.env /var/growyourlist/gyl-broadcaster/.env

            '/tmp/gyl-enable-services.sh':
              encoding: plain
              mode: '000644'
              owner: root
              group: root
              content: |
                #!/bin/bash
                systemctl enable gyl-queue
                systemctl enable gyl-broadcaster
                systemctl enable gyl-subscriber-count
                systemctl start gyl-queue
                systemctl start gyl-broadcaster
                systemctl start gyl-subscriber-count

          commands:
            runGyl001:
              command: 'sh /tmp/gyl-install-dependencies.sh'
            runGyl002:
              command: 'sh /tmp/gyl-mv-env-files.sh'
            runGyl003:
              command: 'sh /tmp/gyl-enable-services.sh'

  GylEC2MainSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Enable SSH access via port 22
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: '22'
            ToPort: '22'
            CidrIp: 0.0.0.0/0

  # API Meta
  GylApiAuthorizerLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-api-authorizer-dist.zip
      Description: Authorizes requests to the GYL API
      FunctionName: GylApiAuthorizer
      Handler: index.authorizer
      Runtime: nodejs12.x
      Role: !GetAtt
        - GylBasicLambdaRole
        - Arn
      Environment:
        Variables:
          ApiAuthKeyHash: !Ref ApiAuthKeyHash
  GylInvokeApiAuthorizerRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylApiAuthorizerLambda
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylInvokeApiAuthorizerPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !GetAtt
                  - GylApiAuthorizerLambda
                  - Arn
  GylApiAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    DependsOn:
      - GylApiAuthorizerLambda
    Properties:
      Name: GylApiAuthorizer
      RestApiId:
        Ref: GylApi
      Type: REQUEST
      AuthorizerUri: !Join
        - ''
        - - 'arn:aws:apigateway:'
          - !Ref 'AWS::Region'
          - ':lambda:path/2015-03-31/functions/'
          - !GetAtt
            - GylApiAuthorizerLambda
            - Arn
          - /invocations
      IdentitySource: method.request.header.X-Gyl-Auth-Key
      Name: GylApiAuthorizer
      AuthorizerResultTtlInSeconds: 60
      AuthorizerCredentials: !GetAtt
        - GylInvokeApiAuthorizerRole
        - Arn
  GylApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: 'GrowYourList API'
      Description: 'API to interact with the GrowYourList mailing list system'
      EndpointConfiguration:
        Types:
          - REGIONAL
  GylApiBetaStage:
    Type: AWS::ApiGateway::Stage
    DependsOn:
      - GylApiDeployment
    Properties:
      DeploymentId: !Ref GylApiDeployment
      RestApiId: !Ref GylApi
      StageName: beta
  GylApiCloudWatchLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        -
          PolicyName: GylApiCloudWatchPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                  - logs:PutLogEvents
                  - logs:GetLogEvents
                  - logs:FilterLogEvents
                Resource: '*'
  GylApiAccount:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn: !GetAtt
        - GylApiCloudWatchLogsRole
        - Arn
  GylApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - GylApiPingGet
      - GylApiAuthPingGet
      - GylApiAutoresponderGet
      - GylApiAnalyticsGet
      - GylApiAutoresponderPost
      - GylApiAutoresponderDelete
      - GylApiAutorespondersGet
      - GylApiBroadcastPost
      - GylApiEmailHistoryGet
      - GylApiListPost
      - GylApiListsGet
      - GylApiSingleEmailSendPost
      - GylApiSubscriberPost
      - GylApiSubscriberDelete
      - GylApiSubscriberQueueGet
      - GylApiSubscriberStatusGet
      - GylApiSubscriberTagPost
      - GylApiSubscriberUntagPost
      - GylApiSubscriberUnsubscribePost
      - GylApiSubscriberCountPost
      - GylApiTemplatePost
      - GylApiTemplateGet
      - GylApiTemplateDelete
      - GylApiTemplatesGet
    Properties:
      RestApiId:
        Ref: GylApi
  GylApiEmptyModel:
    Type: AWS::ApiGateway::Model
    Properties:
      ContentType: application/json
      Description: This is a default empty schema model
      Name: GylApiEmptyModel
      RestApiId:
        Ref: GylApi
      Schema: !Join
        - ''
        - - '{'
          - '"$schema":"http://json-schema.org/draft-04/schema#",'
          - '"title":"Empty Schema",'
          - '"type":"object",'
          - '"definitions":{}'
          - '}'

  # API Lambda integrations
  GylBasicLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  ## Api Ping
  GylPingLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: !Join
         - ''
         - - 'exports.handler=async e=>('
           - '{statusCode:200,body:JSON.stringify("OK"),headers:{'
           - "'Access-Control-Allow-Origin':'*'"
           - '}}'
           - ')'
      Description: Returns 200 OK
      FunctionName: GylPingLambda
      Handler: index.handler
      Role: !GetAtt
        - GylBasicLambdaRole
        - Arn
      Runtime: nodejs12.x
  GylPingPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylPingLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiPingResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !GetAtt
        - GylApi
        - RootResourceId
      PathPart: ping
  GylApiPingOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiPingResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'GET,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiPingGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylPingPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiPingResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylPingLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"

  ## Api Auth Ping
  GylApiAuthPingResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !GetAtt
        - GylApi
        - RootResourceId
      PathPart: auth-ping
  GylApiAuthPingOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiAuthPingResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'GET,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiAuthPingGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylPingPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiAuthPingResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylPingLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"

  ## Api admin resource
  GylApiAdminResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !GetAtt
        - GylApi
        - RootResourceId
      PathPart: admin

  ## Api Subscriber
  ### BEGIN GENERATED PART
  GylAnalyticsGetLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylQueueTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylAnalyticsGetLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylAnalyticsGet:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !GetAtt
                    - GylQueueTable
                    - Arn
  GylAnalyticsGetLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-analytics-get-dist.zip
      Description: Gets email analytics
      FunctionName: GylAnalyticsGet
      Handler: index.handler
      Role: !GetAtt
        - GylAnalyticsGetLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylAnalyticsGetPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylAnalyticsGetLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiAnalyticsGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylAnalyticsGetPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiAnalyticsResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylAnalyticsGetLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiAnalyticsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: analytics
  GylApiAnalyticsOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiAnalyticsResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'GET,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylAutoresponderPostLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSettingsTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylAutoresponderPostLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylAutoresponderPost:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                Resource:
                  - !GetAtt
                    - GylSettingsTable
                    - Arn
  GylAutoresponderPostLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-autoresponder-post-dist.zip
      Description: Posts (creates or updates) an autoresponder
      FunctionName: GylAutoresponderPost
      Handler: index.handler
      Role: !GetAtt
        - GylAutoresponderPostLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylAutoresponderPostPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylAutoresponderPostLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiAutoresponderPost:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylAutoresponderPostPermission
    Properties:
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiAutoresponderResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylAutoresponderPostLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylAutoresponderGetLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSettingsTable 
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylAutoresponderGetLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylAutoresponderGet:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                Resource:
                  - !GetAtt
                    - GylSettingsTable
                    - Arn
  GylAutoresponderGetLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-autoresponder-get-dist.zip
      Description: Gets an autoresponder
      FunctionName: GylAutoresponderGet
      Handler: index.handler
      Role: !GetAtt
        - GylAutoresponderGetLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylAutoresponderGetPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylAutoresponderGetLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiAutoresponderGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylAutoresponderGetPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiAutoresponderResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylAutoresponderGetLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylAutoresponderDeleteLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSettingsTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylAutoresponderDeleteLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylAutoresponderDelete:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:DeleteItem
                Resource:
                  - !GetAtt
                    - GylSettingsTable
                    - Arn
  GylAutoresponderDeleteLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-autoresponder-delete-dist.zip
      Description: Deletes an autoresponder
      FunctionName: GylAutoresponderDelete
      Handler: index.handler
      Role: !GetAtt
        - GylAutoresponderDeleteLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylAutoresponderDeletePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylAutoresponderDeleteLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiAutoresponderDelete:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylAutoresponderDeletePermission
    Properties:
      HttpMethod: DELETE
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiAutoresponderResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylAutoresponderDeleteLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiAutoresponderResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: autoresponder
  GylApiAutoresponderOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiAutoresponderResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'POST,GET,DELETE,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylAutorespondersGetLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSettingsTable 
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylAutorespondersGetLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylAutorespondersGet:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:Scan
                Resource:
                  - !GetAtt
                    - GylSettingsTable
                    - Arn
  GylAutorespondersGetLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-autoresponders-get-dist.zip
      Description: Gets a list of autoresponders
      FunctionName: GylAutorespondersGet
      Handler: index.handler
      Role: !GetAtt
        - GylAutorespondersGetLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylAutorespondersGetPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylAutorespondersGetLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiAutorespondersGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylAutorespondersGetPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiAutorespondersResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylAutorespondersGetLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiAutorespondersResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: autoresponders
  GylApiAutorespondersOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiAutorespondersResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'GET,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylBroadcastPostLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSettingsTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylBroadcastPostLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylBroadcastPost:*'
              -
                Effect: Allow
                Action:
                  - ses:GetTemplate
                Resource: '*'
              -
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                Resource:
                  - !GetAtt
                    - GylSettingsTable
                    - Arn
  GylBroadcastPostLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-broadcast-post-dist.zip
      Description: Triggers a broadcast
      FunctionName: GylBroadcastPost
      Handler: index.handler
      Role: !GetAtt
        - GylBroadcastPostLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylBroadcastPostPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylBroadcastPostLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiBroadcastPost:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylBroadcastPostPermission
    Properties:
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiBroadcastResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylBroadcastPostLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiBroadcastResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: broadcast
  GylApiBroadcastOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiBroadcastResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'POST,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylEmailHistoryGetLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSettingsTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylEmailHistoryGetLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylEmailHistoryGet:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                Resource:
                  - !GetAtt
                    - GylSettingsTable
                    - Arn
  GylEmailHistoryGetLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-email-history-get-dist.zip
      Description: Gets the history of sent emails
      FunctionName: GylEmailHistoryGet
      Handler: index.handler
      Role: !GetAtt
        - GylEmailHistoryGetLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylEmailHistoryGetPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylEmailHistoryGetLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiEmailHistoryGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylEmailHistoryGetPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiEmailHistoryResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylEmailHistoryGetLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiEmailHistoryResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: email-history
  GylApiEmailHistoryOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiEmailHistoryResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'GET,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylListPostLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSettingsTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylListPostLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylListPost:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:UpdateItem
                  - dynamodb:GetItem
                Resource:
                  - !GetAtt
                    - GylSettingsTable
                    - Arn
  GylListPostLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-list-post-dist.zip
      Description: Posts a info about a new list
      FunctionName: GylListPost
      Handler: index.handler
      Role: !GetAtt
        - GylListPostLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylListPostPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylListPostLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiListPost:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylListPostPermission
    Properties:
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiListResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylListPostLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiListResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: list
  GylApiListOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiListResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'POST,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylListsGetLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSettingsTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylListsGetLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylListsGet:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                Resource:
                  - !GetAtt
                    - GylSettingsTable
                    - Arn
  GylListsGetLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-lists-get-dist.zip
      Description: Posts a info about a new list
      FunctionName: GylListsGet
      Handler: index.handler
      Role: !GetAtt
        - GylListsGetLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylListsGetPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylListsGetLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiListsGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylListsGetPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiListsResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylListsGetLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiListsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: lists
  GylApiListsOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiListsResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'GET,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylSingleEmailSendPostLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylSingleEmailSendPostLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylSingleEmailSendPost:*'
              -
                Effect: Allow
                Action:
                  - ses:SendEmail
                Resource: '*'
  GylSingleEmailSendPostLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-single-email-send-post-dist.zip
      Description: Sends a single email using given text and/or html
      FunctionName: GylSingleEmailSendPost
      Handler: index.handler
      Role: !GetAtt
        - GylSingleEmailSendPostLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          SOURCE_EMAIL_ADDRESS: !Ref SesSourceEmail
  GylSingleEmailSendPostPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylSingleEmailSendPostLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiSingleEmailSendPost:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylSingleEmailSendPostPermission
    Properties:
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSingleEmailSendResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylSingleEmailSendPostLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiSingleEmailSendResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: single-email-send
  GylApiSingleEmailSendOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSingleEmailSendResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'POST,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylSubscriberPostLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSubscribersTable
      - GylQueueTable
      - GylSettingsTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylSubscriberPostLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylSubscriberPost:*'
              -
                Effect: Allow
                Action:
                  - ses:SendTemplatedEmail
                Resource: '*'
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylSubscribersTable
                        - Arn
                      - /index/EmailToStatusIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                Resource:
                  - !GetAtt
                    - GylSubscribersTable
                    - Arn
              -
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                Resource:
                  - !GetAtt
                    - GylSettingsTable
                    - Arn
              -
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                Resource:
                  - !GetAtt
                    - GylQueueTable
                    - Arn
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylQueueTable
                        - Arn
                      - /index/SubscriberIdIndex
  GylSubscriberPostLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-subscriber-post-dist.zip
      Description: Posts (create or update if email exists) a subscriber
      FunctionName: GylSubscriberPost
      Handler: index.handler
      Role: !GetAtt
        - GylSubscriberPostLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
          SOURCE_EMAIL: !Ref SesSourceEmail
  GylSubscriberPostPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylSubscriberPostLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiSubscriberPost:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylSubscriberPostPermission
    Properties:
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylSubscriberPostLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylSubscriberDeleteLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSubscribersTable
      - GylQueueTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylSubscriberDeleteLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylSubscriberDelete:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylSubscribersTable
                        - Arn
                      - /index/EmailToStatusIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylQueueTable
                        - Arn
                      - /index/SubscriberIdIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:BatchWriteItem
                Resource:
                  - !GetAtt
                    - GylQueueTable
                    - Arn
              -
                Effect: Allow
                Action:
                  - dynamodb:DeleteItem
                Resource:
                  - !GetAtt
                    - GylSubscribersTable
                    - Arn
  GylSubscriberDeleteLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-subscriber-delete-dist.zip
      Description: Deletes a subscriber
      FunctionName: GylSubscriberDelete
      Handler: index.handler
      Role: !GetAtt
        - GylSubscriberDeleteLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylSubscriberDeletePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylSubscriberDeleteLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiSubscriberDelete:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylSubscriberDeletePermission
    Properties:
      HttpMethod: DELETE
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylSubscriberDeleteLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiSubscriberResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: subscriber
  GylApiSubscriberOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'POST,DELETE,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylSubscriberQueueGetLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSubscribersTable
      - GylQueueTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylSubscriberQueueGetLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylSubscriberQueueGet:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylSubscribersTable
                        - Arn
                      - /index/EmailToStatusIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylQueueTable
                        - Arn
                      - /index/SubscriberIdIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:BatchGetItem
                Resource:
                  - !GetAtt
                    - GylQueueTable
                    - Arn
  GylSubscriberQueueGetLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-subscriber-queue-get-dist.zip
      Description: Gets a subscribers queued items
      FunctionName: GylSubscriberQueueGet
      Handler: index.handler
      Role: !GetAtt
        - GylSubscriberQueueGetLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylSubscriberQueueGetPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylSubscriberQueueGetLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiSubscriberQueueGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylSubscriberQueueGetPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberQueueResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylSubscriberQueueGetLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiSubscriberQueueResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiSubscriberResource
      PathPart: queue
  GylApiSubscriberQueueOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberQueueResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'GET,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylSubscriberStatusGetLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSubscribersTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylSubscriberStatusGetLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylSubscriberStatusGet:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylSubscribersTable
                        - Arn
                      - /index/EmailToStatusIndex
  GylSubscriberStatusGetLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-subscriber-status-get-dist.zip
      Description: Gets the status of a subscriber (subscriberId, email, unsubscribed, confirmed, tags)
      FunctionName: GylSubscriberStatusGet
      Handler: index.handler
      Role: !GetAtt
        - GylSubscriberStatusGetLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylSubscriberStatusGetPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylSubscriberStatusGetLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiSubscriberStatusGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylSubscriberStatusGetPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberStatusResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylSubscriberStatusGetLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiSubscriberStatusResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiSubscriberResource
      PathPart: status
  GylApiSubscriberStatusOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberStatusResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'GET,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylSubscriberTagPostLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSubscribersTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylSubscriberTagPostLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylSubscriberTagPost:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylSubscribersTable
                        - Arn
                      - /index/EmailToStatusIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt
                    - GylSubscribersTable
                    - Arn
  GylSubscriberTagPostLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-subscriber-tag-post-dist.zip
      Description: Adds a tag to a subscriber.
      FunctionName: GylSubscriberTagPost
      Handler: index.handler
      Role: !GetAtt
        - GylSubscriberTagPostLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylSubscriberTagPostPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylSubscriberTagPostLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiSubscriberTagPost:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylSubscriberTagPostPermission
    Properties:
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberTagResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylSubscriberTagPostLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiSubscriberTagResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiSubscriberResource
      PathPart: tag
  GylApiSubscriberTagOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberTagResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'POST,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylSubscriberUntagPostLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSubscribersTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylSubscriberUntagPostLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylSubscriberUntagPost:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylSubscribersTable
                        - Arn
                      - /index/EmailToStatusIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt
                    - GylSubscribersTable
                    - Arn
  GylSubscriberUntagPostLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-subscriber-untag-post-dist.zip
      Description: Removes a tag from a subscriber.
      FunctionName: GylSubscriberUntagPost
      Handler: index.handler
      Role: !GetAtt
        - GylSubscriberUntagPostLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylSubscriberUntagPostPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylSubscriberUntagPostLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiSubscriberUntagPost:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylSubscriberUntagPostPermission
    Properties:
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberUntagResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylSubscriberUntagPostLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiSubscriberUntagResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiSubscriberResource
      PathPart: untag
  GylApiSubscriberUntagOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberUntagResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'POST,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylSubscriberUnsubscribePostLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSubscribersTable
      - GylQueueTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylSubscriberUnsubscribePostLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylSubscriberUnsubscribePost:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylSubscribersTable
                        - Arn
                      - /index/EmailToStatusIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt
                    - GylSubscribersTable
                    - Arn
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylQueueTable
                        - Arn
                      - /index/SubscriberIdIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:BatchWriteItem
                Resource:
                  - !GetAtt
                    - GylQueueTable
                    - Arn
  GylSubscriberUnsubscribePostLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-subscriber-unsubscribe-post-dist.zip
      Description: Unsubscribes a subscriber
      FunctionName: GylSubscriberUnsubscribePost
      Handler: index.handler
      Role: !GetAtt
        - GylSubscriberUnsubscribePostLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylSubscriberUnsubscribePostPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylSubscriberUnsubscribePostLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiSubscriberUnsubscribePost:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylSubscriberUnsubscribePostPermission
    Properties:
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberUnsubscribeResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylSubscriberUnsubscribePostLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiSubscriberUnsubscribeResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiSubscriberResource
      PathPart: unsubscribe
  GylApiSubscriberUnsubscribeOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberUnsubscribeResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'POST,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylSubscriberCountPostLambdaRole:
    Type: AWS::IAM::Role
    DependsOn:
      - GylSettingsTable
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylSubscriberCountPostLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylSubscriberCountPost:*'
              -
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                Resource:
                  - !GetAtt
                    - GylSettingsTable
                    - Arn
  GylSubscriberCountPostLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-subscriber-count-post-dist.zip
      Description: Triggers a count of subscribers
      FunctionName: GylSubscriberCountPost
      Handler: index.handler
      Role: !GetAtt
        - GylSubscriberCountPostLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylSubscriberCountPostPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylSubscriberCountPostLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiSubscriberCountPost:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylSubscriberCountPostPermission
    Properties:
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberCountResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylSubscriberCountPostLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiSubscriberCountResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: subscriber-count
  GylApiSubscriberCountOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiSubscriberCountResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'POST,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylTemplatePostLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylTemplatePostLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylTemplatePost:*'
              -
                Effect: Allow
                Action:
                  - ses:CreateTemplate
                  - ses:UpdateTemplate
                Resource: '*'
  GylTemplatePostLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-template-post-dist.zip
      Description: Posts (creates or updates) an email template.
      FunctionName: GylTemplatePost
      Handler: index.handler
      Role: !GetAtt
        - GylTemplatePostLambdaRole
        - Arn
      Runtime: nodejs12.x
  GylTemplatePostPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylTemplatePostLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiTemplatePost:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylTemplatePostPermission
    Properties:
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiTemplateResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylTemplatePostLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylTemplateGetLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylTemplateGetLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylTemplateGet:*'
              -
                Effect: Allow
                Action:
                  - ses:GetTemplate
                Resource: '*'
  GylTemplateGetLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-template-get-dist.zip
      Description: Gets an email template.
      FunctionName: GylTemplateGet
      Handler: index.handler
      Role: !GetAtt
        - GylTemplateGetLambdaRole
        - Arn
      Runtime: nodejs12.x
  GylTemplateGetPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylTemplateGetLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiTemplateGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylTemplateGetPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiTemplateResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylTemplateGetLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylTemplateDeleteLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylTemplateDeleteLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylTemplateDelete:*'
              -
                Effect: Allow
                Action:
                  - ses:DeleteTemplate
                Resource: '*'
  GylTemplateDeleteLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-template-delete-dist.zip
      Description: Deletes an email template.
      FunctionName: GylTemplateDelete
      Handler: index.handler
      Role: !GetAtt
        - GylTemplateDeleteLambdaRole
        - Arn
      Runtime: nodejs12.x
  GylTemplateDeletePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylTemplateDeleteLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiTemplateDelete:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylTemplateDeletePermission
    Properties:
      HttpMethod: DELETE
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiTemplateResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylTemplateDeleteLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiTemplateResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: template
  GylApiTemplateOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiTemplateResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'POST,GET,DELETE,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylTemplatesGetLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylTemplatesGetLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':*'
              -
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Join
                  - ''
                  - - 'arn:aws:logs:'
                    - 
                      Ref: AWS::Region
                    - ':'
                    -
                      Ref: AWS::AccountId
                    - ':log-group:/aws/lambda/GylTemplatesGet:*'
              -
                Effect: Allow
                Action:
                  - ses:ListTemplates
                Resource: '*'
  GylTemplatesGetLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-admin-templates-get-dist.zip
      Description: Gets a list of meta info about templates.
      FunctionName: GylTemplatesGet
      Handler: index.handler
      Role: !GetAtt
        - GylTemplatesGetLambdaRole
        - Arn
      Runtime: nodejs12.x
  GylTemplatesGetPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylTemplatesGetLambda
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:execute-api:'
          - 
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          -
            Ref: GylApi
          - '/*'
  GylApiTemplatesGet:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylTemplatesGetPermission
    Properties:
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref GylApiAuthorizer
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiTemplatesResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            -
              Ref: AWS::Region
            - :lambda:path/2015-03-31/functions/
            -
              !GetAtt
                - GylTemplatesGetLambda
                - Arn
            - /invocations
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
  GylApiTemplatesResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: GylApi
      ParentId: !Ref GylApiAdminResource
      PathPart: templates
  GylApiTemplatesOptions:
    Type: AWS::ApiGateway::Method
    DependsOn:
      - GylApiEmptyModel
    Properties:
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      ApiKeyRequired: false
      RequestParameters: {}
      ResourceId:
        Ref: GylApiTemplatesResource
      RestApiId:
        Ref: GylApi
      MethodResponses:
        -
          StatusCode: '200'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          ResponseModels:
            application/json: GylApiEmptyModel
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          -
            StatusCode: '200'
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: >-
                'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Gyl-Auth-Key'
              method.response.header.Access-Control-Allow-Methods: >-
                'GET,OPTIONS'
              method.response.header.Access-Control-Allow-Origin: "'*'"
  ### END GENERATED PART

  # SNS Lambda Functions
  GylReactToInteractionLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylReactToInteractionLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylSubscribersTable
                        - Arn
                      - /index/EmailToStatusIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:UpdateItem
                Resource: !GetAtt
                  - GylSubscribersTable
                  - Arn
              -
                Effect: Allow
                Action:
                  - dynamodb:UpdateItem
                Resource: !GetAtt
                  - GylQueueTable
                  - Arn
  GylReactToInteractionLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-react-to-interaction-dist.zip
      Description: Lambda function to react to interactions with emails.
      FunctionName: GylReactToInteraction
      Handler: index.handler
      Role: !GetAtt
        - GylReactToInteractionLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylReactToInteractionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylReactToInteractionLambda
        - Arn
      Principal: sns.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:sns:'
          -
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          - GylOpenAndClickTopic

  GylReactToUnsubscribeEventLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        -
          PolicyName: GylReactToUnsubscribeEventLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource:
                  - !Join
                    - ''
                    - - !GetAtt
                        - GylSubscribersTable
                        - Arn
                      - /index/EmailToStatusIndex
              -
                Effect: Allow
                Action:
                  - dynamodb:UpdateItem
                Resource: !GetAtt
                  - GylSubscribersTable
                  - Arn
              - 
                Effect: Allow
                Action:
                  - dynamodb:Query
                  - dynamodb:BatchWriteItem
                Resource: !GetAtt
                  - GylQueueTable
                  - Arn
  GylReactToUnsubscribeEventLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaBucketName
        S3Key: gyl-react-to-unsubscribe-event-dist.zip
      Description: Lambda function to react to unsubscribe events.
      FunctionName: GylReactToUnsubscribeEventLambda
      Handler: index.handler
      Role: !GetAtt
        - GylReactToUnsubscribeEventLambdaRole
        - Arn
      Runtime: nodejs12.x
      Environment:
        Variables:
          DB_TABLE_PREFIX: !Ref DbTablePrefix
  GylReactToUnsubscribeEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:invokeFunction
      FunctionName: !GetAtt
        - GylReactToUnsubscribeEventLambda
        - Arn
      Principal: sns.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:aws:sns:'
          -
            Ref: AWS::Region
          - ':'
          -
            Ref: AWS::AccountId
          - ':'
          - GylUnsubscribeEventTopic

  # DynamoDB Tables
  GylSettingsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        -
          AttributeName: settingName
          AttributeType: S
      TableName: !Sub
        - '${DbTablePrefix}Settings'
        - 
          DbTablePrefix: !Ref DbTablePrefix
      KeySchema:
        -
          AttributeName: settingName
          KeyType: HASH
  GylQueueTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      TableName: !Sub
        - '${DbTablePrefix}Queue'
        - 
          DbTablePrefix: !Ref DbTablePrefix
      AttributeDefinitions:
        -
          AttributeName: queuePlacement
          AttributeType: S
        -
          AttributeName: runAtModified
          AttributeType: S
        -
          AttributeName: subscriberId
          AttributeType: S
      KeySchema:
        -
          AttributeName: queuePlacement
          KeyType: HASH
        -
          AttributeName: runAtModified
          KeyType: RANGE
      GlobalSecondaryIndexes:
        -
          IndexName: SubscriberIdIndex
          KeySchema:
            -
              AttributeName: subscriberId
              KeyType: HASH
          Projection:
            NonKeyAttributes:
              - tagReason
            ProjectionType: INCLUDE
  GylSubscribersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      TableName: !Sub
        - '${DbTablePrefix}Subscribers'
        - 
          DbTablePrefix: !Ref DbTablePrefix
      AttributeDefinitions:
        -
          AttributeName: subscriberId
          AttributeType: S
        -
          AttributeName: email
          AttributeType: S
      KeySchema:
        -
          AttributeName: subscriberId
          KeyType: HASH
      GlobalSecondaryIndexes:
        -
          IndexName: EmailToStatusIndex
          KeySchema:
            -
              AttributeName: email
              KeyType: HASH
          Projection:
            NonKeyAttributes:
              - displayEmail
              - unsubscribed
              - confirmed
              - tags
            ProjectionType: INCLUDE

  # SNS
  GylOpenAndClickTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        -
          Endpoint: !GetAtt
            - GylReactToInteractionLambda
            - Arn
          Protocol: lambda
      TopicName: GylOpenAndClickTopic
  GylUnsubscribeEventTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        -
          Endpoint: !GetAtt
            - GylReactToUnsubscribeEventLambda
            - Arn
          Protocol: lambda
      TopicName: GylUnsubscribeEventTopic
  GylSesFailureEventTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        -
          Endpoint: !Ref AdminEmail
          Protocol: email
      TopicName: GylSesFailureEventTopic

  # SES
  GylSesConfigurationSet:
    Type: AWS::SES::ConfigurationSet
    Properties:
      Name: GylSesConfigurationSet

Outputs:
  GylEC2MainHostname:
    Description: 'EC2 Hostname'
    Value: !Join
      - ''
      - - !GetAtt
          - GylEC2Main
          - PublicDnsName
  GylApiUrl:
    Description: 'GYL API Url'
    Value: !Join
      - ''
      - - https://
        -
          Ref: GylApi
        - .execute-api.
        -
          Ref: AWS::Region
        - .amazonaws.com/
  GylApiBetaStage:
    Description: 'GYL API Stage'
    Value: !Ref GylApiBetaStage
  GylSesConfigurationSet:
    Description: GylSesConfigurationSet
    Value: !Ref GylSesConfigurationSet
  GylOpenAndClickTopic:
    Description: GylOpenAndClickTopic
    Value: !Ref GylOpenAndClickTopic
  GylUnsubscribeEventTopic:
    Description: GylUnsubscribeEventTopic
    Value: !Ref GylUnsubscribeEventTopic
  GylSesFailureEventTopic:
    Description: GylSesFailureEventTopic
    Value: !Ref GylSesFailureEventTopic
